inputs:
  username:
    description: docker username
    required: true
    default: ${{ github.actor }}
  password:
    description: docker password
    required: true
  registry:
    description: registry hostname
    default: ghcr.io
runs:
  using: "composite"
  steps:
  - uses: docker/setup-qemu-action@v2
  - uses: docker/setup-buildx-action@v2
  - name: login to container registry
    uses: docker/login-action@v2
    with:
      registry: ${{ inputs.registry }}
      username: ${{ inputs.username }}
      password: ${{ inputs.password }}
  - name: build and push
    uses: docker/build-push-action@v4
    with:
      context: ./docker
      build-args: |
        GH_BRANCH=${{ github.ref_name }}
      push: true
      platforms: linux/amd64,linux/arm64
      tags: ${{ inputs.registry }}/${{ github.repository }}:${{ github.ref_name }}
  - name: build and push(main)
    if: github.ref_name == 'main'
    uses: docker/build-push-action@v4
    with:
      build-args: |
        GH_BRANCH=${{ github.ref_name }}
      context: ./docker
      push: true
      platforms: linux/amd64,linux/arm64
      tags: ${{ inputs.registry }}/${{ github.repository }}:latest
